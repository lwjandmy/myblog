# redux saga helloworld

```js
import { createStore, applyMiddleware } from 'redux';
import createSagaMiddleware from 'redux-saga';
import { takeEvery, takeLatest } from 'redux-saga';
import { call, put } from 'redux-saga/effects';
import { deepEqual } from 'assert';


// 定义2个方法, 用于获取数据, 返回promise, 类比为现有的异步方法, 与saga无关

function appleFetch(appleId) {
  console.log('appleFetch            --- appleId:', appleId); // 3
  return new Promise((resolve, reject) => {
    let result = { appleName: 'apple' + appleId };
    console.log('appleFetch            --- return:', result); // 4
    resolve(result);
  });
}

function userFetch(userId) {
  console.log('userFetch             --- userId:', userId)
  return new Promise((resolve, reject) => {
    let userData = { userName: 'user' + userId };
    console.log('userFetch             --- return:', userData);
    resolve(userData);
  });
}


// 定义2个Generator, 用于分别处理2个action, 内部调用上面两个异步方法
// 方法调用用call, action推送用put

function* onAppleFetchRequested(action) {
  console.log('onAppleFetchRequested --- call:', 'appleFetch', action.payload.appleId); // 2
  let appleData = yield call(appleFetch, action.payload.appleId);
  let result = {type: 'APPLE_FETCH_SUCCEEDED', payload: appleData};
  console.log('onAppleFetchRequested --- put:', result); // 5
  yield put(result);
}

function* onUserFetchRequested(action) {
  console.log('onUserFetchRequested  --- call:', 'fetchUser', action.payload.userId)
  let userData = yield call(userFetch, action.payload.userId);
  let result = {type: "USER_FETCH_SUCCEEDED", payload: userData};
  console.log('onUserFetchRequested  --- put:', result);
  yield put(result);
}


// 定义saga方法, 里面定义所有监听的action, 和对应的Generator

function* rootSaga() {
  yield [
    takeEvery('APPLE_FETCH_REQUESTED', onAppleFetchRequested),
    takeEvery('USER_FETCH_REQUESTED', onUserFetchRequested)
  ];
}


function reducer(state, action) {
  return { ...state }
}


// 创建saga中间件, 运行rootSaga

const sagaMiddleware = createSagaMiddleware();
const store = applyMiddleware(sagaMiddleware)(createStore)(reducer);
sagaMiddleware.run(rootSaga);


store.dispatch({type: 'APPLE_FETCH_REQUESTED', payload: { appleId: 1 }}); // 1


setTimeout(() => {
  store.dispatch({type: 'USER_FETCH_REQUESTED', payload: { userId: 2 }});
}, 1000);


setTimeout(() => {
  console.log('开始单元测试');
  const gen = onAppleFetchRequested({payload: { appleId: 1 }});
  deepEqual(gen.next(), { done: false, value: call(appleFetch, 1) });
  deepEqual(gen.next({a: 1}), { done: false, value: put({type: 'APPLE_FETCH_SUCCEEDED', payload: {a: 1}}) });
  deepEqual(gen.next(), { done: true, value: undefined });
}, 2000);

```