

<html><head><meta charset="UTF-8"><title>fabric sdk 整理
</title><meta name="viewport" content="width=device-width, initial-scala=1.0"></head><body><div id="markdown">






<h1 id="fabric-sdk-">fabric sdk 整理</h1>
<p>BasicTools.java</p>
<pre><code class="lang-java">
/**
 * fabric-sdk-java提供的对链码query和invoke调用的功能封装
 *
 */
public class BasicTools {

    public static final TestConfig testConfig = TestConfig.getConfig();

    // SampleStore说明 将admin, user1这些用户信息, 暂存到
    // src/test/fixture/sdkintegration/e2e-2Orgs/HFCSampletest.properties文件
    // SampleStore.getMember方法, 如果文件存过数据, 从文件里读, 否则执行new SampleUser,
    // 构造时传入SampleStore
    // SampleUser的每个set方法, 都会执行内部的saveState方法,
    // 会调用SampleStore.setValue将数据写入到文件
//    public static final SampleStore sampleStore = new SampleStore(new File(System.getProperty(&quot;java.io.tmpdir&quot;) + &quot;/HFCSampletest.properties&quot;));
    public static final SampleStore sampleStore = new SampleStore(Paths.get(testConfig.getTestChannelPath(), &quot;..&quot;, &quot;HFCSampletest.properties&quot;).toFile());

    @SuppressWarnings(&quot;unused&quot;)
    private static final Log logger = LogFactory.getLog(BasicTools.class);

    private static final Random random = new Random();

//    static {
//        logger.info(&quot;相对路径起始位置: &quot; + Paths.get(&quot;&quot;).toAbsolutePath());
//    }

    /**
     * 构造HyperLedger Client
     */
    public static HFClient createClient() throws CryptoException, InvalidArgumentException, IllegalAccessException, InstantiationException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException {
        HFClient client = HFClient.createNewInstance();
        client.setCryptoSuite(CryptoSuite.Factory.getCryptoSuite());
        return client;
    }

    /**
     * 构造HyperLedger CA Client
     * @param caName ca的名字, 如&quot;ca.example.com&quot;
     * @param caUrl ca服务器地址, 如&quot;http://192.168.56.101:7054&quot;
     */
    public static HFCAClient createCaClient(String caName, String caUrl) throws MalformedURLException, org.hyperledger.fabric_ca.sdk.exception.InvalidArgumentException, IllegalAccessException, InstantiationException, ClassNotFoundException, CryptoException, InvalidArgumentException, NoSuchMethodException, InvocationTargetException {
        Properties properties = new Properties();
        HFCAClient ca = HFCAClient.createNewInstance(caName, caUrl, properties);
        ca.setCryptoSuite(CryptoSuite.Factory.getCryptoSuite());
        return ca;
    }

    /**
     * 获取一个SampleUser对象, 表示用户
     * 当执行SampleUser对象的方法名以set开头方法时, 会将对象序列化存储在本地文件C:\Users\&lt;user-name&gt;\AppData\Local\Temp\HFCSampletest.properties
     * @param userName 用户名, 如&quot;user1&quot;, &quot;admin&quot;
     * @param mspId 用户的mspId, 在peer节点, 环境变量CORE_PEER_LOCALMSPID指定了这个值, 并和文件路径/etc/hyperledger/fabric/msp关联, 如&quot;Org1MSP&quot;
     * @param userOrg 用户所属组, 如&quot;Org1MSP&quot;
     */
    public static SampleUser getUserPersistent(String userName, String mspId) {
        return sampleStore.getMember(userName, mspId);
    }

    /**
     * 执行用户的注册和登记
     * @param user 要被注册和登记的用户对象
     * @param caClient ca服务客户端, 进行用户注册和登记
     * @param userMspId 用户的mspId, 在peer节点, 环境变量CORE_PEER_LOCALMSPID指定了这个值, 并和文件路径/etc/hyperledger/fabric/msp关联, 如&quot;Org1MSP&quot;
     * @param userAffiliation 注册用户的所属机构部门, 如&quot;org1.department1&quot;
     * @param adminName 管理员用户名, 使用管理员身份进行用户注册, 如&quot;admin&quot;
     * @param adminMspId 管理员的mspId, 在peer节点, 环境变量CORE_PEER_LOCALMSPID指定了这个值, 并和文件路径/etc/hyperledger/fabric/msp关联, 如&quot;Org1MSP&quot;
     * @param adminPassword 管理员密码, 使用管理员身份进行用户注册, 如&quot;adminpw&quot;
     */
    public static void userRegisterAndEnroll(SampleUser user, HFCAClient caClient, String userMspId, String userAffiliation, String adminName, String adminMspId, String adminPassword) throws EnrollmentException, org.hyperledger.fabric_ca.sdk.exception.InvalidArgumentException, RegistrationException {
        // 注册用户user
        if (!user.isRegistered()) {

            // 获得用户admin, 用于注册user
            SampleUser admin = getUserPersistent(adminName, adminMspId);

            // 登记用户admin
            if (!admin.isEnrolled()) {
                admin.setEnrollment(caClient.enroll(admin.getName(), adminPassword));
                admin.setMspId(adminMspId);
            }

            // 注册用户user
            RegistrationRequest rr;
            try {
                rr = new RegistrationRequest(user.getName(), userAffiliation); // 这里竟然抛出了Exception异常, 估计是偷懒, 这里异常类型转成InvalidArgumentException
            } catch (Exception e) {
                throw new org.hyperledger.fabric_ca.sdk.exception.InvalidArgumentException(e);
            }
            user.setEnrollmentSecret(caClient.register(rr, admin));
        }

        // 登记用户user
        if (!user.isEnrolled()) {
            user.setEnrollment(caClient.enroll(user.getName(), user.getEnrollmentSecret()));
            user.setMspId(userMspId);
        }
    }

    /**
     * 获取orderer对象
     * @param client HyperLedger Client
     * @param ordererName orderer名, 如&quot;orderer.example.com&quot;
     * @param ordererGrpcUrl orderer服务的grpc地址, 如&quot;grpc://192.168.56.101:7050&quot;
     */
    public static Orderer getOrderer(HFClient client, String ordererName, String ordererGrpcUrl) throws InvalidArgumentException {
        Properties ordererProperties = testConfig.getOrdererProperties(ordererName);
        ordererProperties.put(&quot;grpc.NettyChannelBuilderOption.keepAliveTime&quot;, new Object[] { 5L, TimeUnit.MINUTES });
        ordererProperties.put(&quot;grpc.NettyChannelBuilderOption.keepAliveTimeout&quot;, new Object[] { 8L, TimeUnit.SECONDS });
        ordererProperties.put(&quot;grpc.NettyChannelBuilderOption.keepAliveWithoutCalls&quot;, new Object[] { true });
        return client.newOrderer(ordererName, ordererGrpcUrl, ordererProperties);
    }

    /**
     * 获取peer对象
     * @param client HyperLedger Client
     * @param peerName peer名, 如&quot;peer0.org1.example.com&quot;
     * @param peerGrpcUrl peer服务的grpc地址, 如&quot;grpc://192.168.56.101:7051&quot;
     */
    public static Peer getPeer(HFClient client, String peerName, String peerGrpcUrl) throws InvalidArgumentException {
        Properties peerProperties0 = testConfig.getPeerProperties(peerName);
        peerProperties0.put(&quot;grpc.NettyChannelBuilderOption.maxInboundMessageSize&quot;, 9000000);
        return client.newPeer(peerName, peerGrpcUrl, peerProperties0);
    }

    /**
     * 创建信道对象
     * @param client HyperLedger Client
     * @param channelName 信道名, 如&quot;mychannel&quot;
     */
    public static Channel createChannel(HFClient client, String channelName) throws InvalidArgumentException {
        return client.newChannel(channelName);
    }

    /**
     * 构造ChaincodeID对象
     * @param chaincodeName 链码名, 如&quot;demo_zichzhsh&quot;
     * @param chaincodeVersion 链码版本, 如&quot;1.0&quot;
     * @param chaincodeSrcPath 链码源码路径, 如&quot;github.com/hyperledger/fabric/examples/chaincode/go/demo_zichzhsh&quot;
     */
    public static ChaincodeID createChaincodeID(String chaincodeName, String chaincodeVersion, String chaincodeSrcPath) {
        return ChaincodeID.newBuilder().setName(chaincodeName).setVersion(chaincodeVersion)
                .setPath(chaincodeSrcPath).build();
    }

    /**
     * 构造QueryByChaincodeRequest对象, 用于封装请求数据
     * @param client HyperLedger Client
     * @param chaincodeID ChaincodeID对象
     * @param functionName 链码函数名, 如&quot;get&quot;
     * @param arguments 链码函数的参数列表, 如[&quot;a&quot;]
     */
    public static QueryByChaincodeRequest createQueryProposalRequest(HFClient client, ChaincodeID chaincodeID, String functionName, String[] arguments) throws InvalidArgumentException {
        QueryByChaincodeRequest queryByChaincodeRequest = client.newQueryProposalRequest();
        queryByChaincodeRequest.setChaincodeID(chaincodeID);
        queryByChaincodeRequest.setFcn(functionName);
        queryByChaincodeRequest.setArgs(arguments);
        Map&lt;String, byte[]&gt; transientMap = new HashMap&lt;&gt;();
        transientMap.put(&quot;HyperLedgerFabric&quot;, &quot;QueryByChaincodeRequest:JavaSDK&quot;.getBytes(UTF_8));
        transientMap.put(&quot;method&quot;, &quot;QueryByChaincodeRequest&quot;.getBytes(UTF_8));
        queryByChaincodeRequest.setTransientMap(transientMap);
        return queryByChaincodeRequest;
    }

    /**
     * 构造TransactionProposalRequest对象, 用于封装请求数据
     * @param client HyperLedger Client
     * @param chaincodeID ChaincodeID对象
     * @param functionName 链码函数名, 如&quot;put&quot;
     * @param arguments 链码函数的参数列表, 如[&quot;a&quot;, &quot;this is a&quot;, &quot;i am a&quot;]
     */
    public static TransactionProposalRequest createTransactionProposalRequest(HFClient client, ChaincodeID chaincodeID, String functionName, String[] arguments) throws InvalidArgumentException {
        TransactionProposalRequest transactionProposalRequest = client.newTransactionProposalRequest();
        transactionProposalRequest.setChaincodeID(chaincodeID);
        transactionProposalRequest.setFcn(functionName);
        transactionProposalRequest.setArgs(arguments);
        transactionProposalRequest.setProposalWaitTime(testConfig.getProposalWaitTime());
        Map&lt;String, byte[]&gt; transientMap = new HashMap&lt;&gt;();
        transientMap.put(&quot;HyperLedgerFabric&quot;, &quot;TransactionProposalRequest:JavaSDK&quot;.getBytes(UTF_8));
        transientMap.put(&quot;method&quot;, &quot;TransactionProposalRequest&quot;.getBytes(UTF_8));
        transientMap.put(&quot;result&quot;, &quot;:)&quot;.getBytes(UTF_8));
        transientMap.put(&quot;event&quot;, &quot;!&quot;.getBytes(UTF_8));
        transactionProposalRequest.setTransientMap(transientMap);
        return transactionProposalRequest;
    }

    /**
     * 从Collection中随机选择一个
     * @param collection Collection对象
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public static &lt;T&gt; T getRandomOne(Collection&lt;T&gt; collection) {

        return (T) CollectionUtils.get(collection, random.nextInt(collection.size()));

    }

    /**
     * 发送query提议, 执行query类型的链码调用
     * @param channel 信道对象
     * @param queryRequest 请求内容
     */
    public static Collection&lt;ProposalResponse&gt; doQuery(Channel channel, QueryByChaincodeRequest queryRequest) throws InvalidArgumentException, ProposalException {
        return channel.queryByChaincode(queryRequest, Arrays.asList(getRandomOne(channel.getPeers())));
    }

    /**
     * 发送transaction提议, 执行transaction类型的链码调用, 将执行成功的ProposalResponse发送给orderer
     * @param channel 信道对象
     * @param transactionProposalRequest 请求内容
     */
    public static Collection&lt;ProposalResponse&gt; doTransaction(Channel channel, TransactionProposalRequest transactionProposalRequest) throws ProposalException, InvalidArgumentException, InterruptedException, ExecutionException, TimeoutException {

        // 发送transaction提议, 执行transaction类型的链码调用
        Collection&lt;ProposalResponse&gt; proposalResponses = channel.sendTransactionProposal(transactionProposalRequest, Arrays.asList(getRandomOne(channel.getPeers())));

        // 保存成功的proposalResponse, 发送给orderer
        Collection&lt;ProposalResponse&gt; successful = new LinkedList&lt;&gt;();
        for (ProposalResponse proposalResponse : proposalResponses) {
            if (isProposalResponseSuccess(proposalResponse)) {
                successful.add(proposalResponse);
            }
        }

        // 发送成功的ProposalResponse给orderer
        channel.sendTransaction(successful).get(2, TimeUnit.SECONDS);

        return proposalResponses;

    }

    /**
     * 判断提议是否成功执行, 通过提议响应(ProposalResponse)来判断
     * @param proposalResponse 提议响应
     */
    public static boolean isProposalResponseSuccess(ProposalResponse proposalResponse) {
        return proposalResponse.isVerified() &amp;&amp; proposalResponse.getStatus() == ProposalResponse.Status.SUCCESS;
    }

    /**
     * 获取提议响应的返回内容, 如果提议执行成功, 返回提议执行结果; 如果提议执行失败, 返回失败内容. 通过isProposalResponseSuccess判断提议执行成功还是失败
     * @param proposalResponse
     */
    public static String getProposalResult(ProposalResponse proposalResponse) {
        if (isProposalResponseSuccess(proposalResponse))
            return proposalResponse.getProposalResponse().getResponse().getPayload().toStringUtf8();
        else
            return proposalResponse.getMessage();
    }
}
</code></pre>
<p>End2End.java</p>
<pre><code class="lang-java">
/**
 * 基于当前区块链网络结构(3个peer), 封装的节点调用类, 单例
 *
 */
public class End2End {

    private HFClient client;
    private HFCAClient caClient;
    private SampleUser user1;
    private Orderer order;
    private Peer peer0;
    private Peer peer1;
    private Peer peer2;
    private Channel channel;

    private static final Log logger = LogFactory.getLog(End2End.class);

    private End2End() throws CryptoException, InvalidArgumentException, IllegalAccessException, InstantiationException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, MalformedURLException, org.hyperledger.fabric_ca.sdk.exception.InvalidArgumentException, EnrollmentException, RegistrationException, TransactionException {

        // 构造HyperLedger Client
        client = BasicTools.createClient();

        // 构造HyperLedger CA Client, 用于用户注册, 用户登记
        caClient = BasicTools.createCaClient(&quot;ca.example.com&quot;, &quot;http://ca.example.com:7054&quot;);

        // 获取用户user1
        user1 = BasicTools.getUserPersistent(&quot;user4&quot;, &quot;Org1MSP&quot;);

        // 注册登记user1
        BasicTools.userRegisterAndEnroll(user1, caClient, &quot;Org1MSP&quot;, &quot;org1.department1&quot;, &quot;admin&quot;, &quot;Org1MSP&quot;, &quot;adminpw&quot;);

        // 设置操作用户为user1
        client.setUserContext(user1);

        // 拷贝文件:
        // Y:\demo-fabric\prepare\crypto-config
        // D:\li_wjie\0区块链研究\FabricTest\src\test\fixture\sdkintegration\e2e-2Orgs\channel\crypto-config
        // D:\li_wjie\10金交所区块链环境\SVN\trunk\code\ts-web\src\test\fixture\sdkintegration\e2e-2Orgs\channel
        // getOrdererProperties, getPeerProperties内部会去读crypto-config

        // 构造Orderer对象
        order = BasicTools.getOrderer(client, &quot;orderer.example.com&quot;, &quot;grpc://orderer.example.com:7050&quot;);

        // 构造Peer0对象
        peer0 = BasicTools.getPeer(client, &quot;peer0.org1.example.com&quot;, &quot;grpc://peer0.org1.example.com:7051&quot;);
        // 构造Peer1对象
        peer1 = BasicTools.getPeer(client, &quot;peer1.org1.example.com&quot;, &quot;grpc://peer1.org1.example.com:8051&quot;);
        // 构造Peer2对象
        peer2 = BasicTools.getPeer(client, &quot;peer2.org1.example.com&quot;, &quot;grpc://peer2.org1.example.com:9051&quot;);

        // 构造channel, 添加orderer和peer到channel, 初始化channel
        channel = BasicTools.createChannel(client, &quot;mychannel&quot;);
        channel.addOrderer(order);
        channel.addPeer(peer0);
        channel.addPeer(peer1);
        channel.addPeer(peer2);
        channel.initialize();

    }

    private static End2End instanct = null;

    public static End2End instance() throws CryptoException, InvalidArgumentException, IllegalAccessException, InstantiationException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, MalformedURLException, org.hyperledger.fabric_ca.sdk.exception.InvalidArgumentException, EnrollmentException, RegistrationException, TransactionException {
        if (null == instanct) {
            synchronized (End2End.class) {
                if (null == instanct) {
                    instanct = new End2End();
                }
            }
        }
        return instanct;
    }

    /**
     * 发送query类型提议请求
     * @param channel 信道对象
     * @param chaincodeID 链码对象
     * @param functionName 链码函数名, 如&quot;get&quot;
     * @param arguments 链码函数的参数列表, 如[&quot;a&quot;]
     */
    public String query(ChaincodeID chaincodeID, String functionName, String[] arguments) throws InvalidArgumentException, TransactionException, ProposalException {

        // 构造一个query类型的提议(proposal)
        QueryByChaincodeRequest queryProposalRequest = BasicTools.createQueryProposalRequest(client, chaincodeID, functionName, arguments);

        // 发送提议请求
        Collection&lt;ProposalResponse&gt; proposalResponses = BasicTools.doQuery(channel, queryProposalRequest);

        for (ProposalResponse proposalResponse : proposalResponses) {
            String result = BasicTools.getProposalResult(proposalResponse);
            if (BasicTools.isProposalResponseSuccess(proposalResponse)) {
                return result;
            } else {
                logger.warn(String.format(
                        &quot;链码执行出错, 可能是当前节点还没同步完数据, 可以忽略此警告, 信息: %s, 信道名: %s, 链码名: %s, 链码版本: %s&quot;, 
                        result, channel.getName(), chaincodeID.getName(), chaincodeID.getVersion()));
            }

        }

        throw new RuntimeException(String.format(
                &quot;链码出错, 如果日志未出现&#39;链码执行出错&#39;开头的日志, 说明没有节点返回过数据, 是链码执行超时. 否则日志会出现&#39;链码执行出错&#39;开头的日志, 并且会出现3条, 分别代表3个节点返回的错误信息, 查看那3条日志的错误信息分析原因&quot;
                ));

    }

    /**
     * 发送invoke类型提议请求
     * @param channel 信道对象
     * @param chaincodeID 链码对象
     * @param functionName 链码函数名, 如&quot;put&quot;
     * @param arguments 链码函数的参数列表, 如[&quot;this is a&quot;, &quot;i am a&quot;]
     */
    public String invoke(ChaincodeID chaincodeID, String functionName, String[] arguments) throws InvalidArgumentException, TransactionException, ProposalException, InterruptedException, ExecutionException, TimeoutException {

        // 构造一个transaction类型的提议(proposal)
        TransactionProposalRequest transactionProposalRequest = BasicTools.createTransactionProposalRequest(client, chaincodeID, functionName, arguments);

        // 发送提议
        Collection&lt;ProposalResponse&gt; proposalResponses = BasicTools.doTransaction(channel, transactionProposalRequest);

        for (ProposalResponse proposalResponse : proposalResponses) {
            String result = BasicTools.getProposalResult(proposalResponse);
            if (BasicTools.isProposalResponseSuccess(proposalResponse)) {
                return result;
            } else {
                logger.warn(String.format(
                        &quot;链码执行出错, 可能是当前节点还没同步完数据, 可以忽略此警告, 信息: %s, 信道名: %s, 链码名: %s, 链码版本: %s&quot;, 
                        result, channel.getName(), chaincodeID.getName(), chaincodeID.getVersion()));
            }

        }

        throw new RuntimeException(String.format(
                &quot;链码出错, 如果日志未出现&#39;链码执行出错&#39;开头的日志, 说明没有节点返回过数据, 是链码执行超时. 否则日志会出现&#39;链码执行出错&#39;开头的日志, 并且会出现3条, 分别代表3个节点返回的错误信息, 查看那3条日志的错误信息分析原因&quot;
                ));

    }


    @SuppressWarnings(&quot;unused&quot;)
    private void queryTest() throws Exception {


        // 构造HyperLedger Client
        HFClient client = BasicTools.createClient();

        // 构造HyperLedger CA Client, 用于用户注册, 用户登记
        HFCAClient caClient = BasicTools.createCaClient(&quot;ca.example.com&quot;, &quot;http://ca.example.com:7054&quot;);

        // 获取用户user1
        SampleUser user1 = BasicTools.getUserPersistent(&quot;user4&quot;, &quot;Org1MSP&quot;);

        // 注册登记user1
        BasicTools.userRegisterAndEnroll(user1, caClient, &quot;Org1MSP&quot;, &quot;org1.department1&quot;, &quot;admin&quot;, &quot;Org1MSP&quot;, &quot;adminpw&quot;);

        // 设置操作用户为user1
        client.setUserContext(user1);

        // 拷贝文件:
        // Y:\demo-fabric\prepare\crypto-config
        // D:\li_wjie\0区块链研究\FabricTest\src\test\fixture\sdkintegration\e2e-2Orgs\channel\crypto-config
        // D:\li_wjie\10金交所区块链环境\SVN\trunk\code\ts-web\src\test\fixture\sdkintegration\e2e-2Orgs\channel
        // getOrdererProperties, getPeerProperties内部会去读crypto-config

        // 构造Orderer对象
        Orderer order = BasicTools.getOrderer(client, &quot;orderer.example.com&quot;, &quot;grpc://orderer.example.com:7050&quot;);

        // 构造Peer0对象
        Peer peer0 = BasicTools.getPeer(client, &quot;peer0.org1.example.com&quot;, &quot;grpc://peer0.org1.example.com:7051&quot;);
        // 构造Peer1对象
        Peer peer1 = BasicTools.getPeer(client, &quot;peer1.org1.example.com&quot;, &quot;grpc://peer1.org1.example.com:8051&quot;);
        // 构造Peer2对象
        Peer peer2 = BasicTools.getPeer(client, &quot;peer2.org1.example.com&quot;, &quot;grpc://peer2.org1.example.com:9051&quot;);

        // 构造channel, 添加orderer和peer到channel, 初始化channel
        // peer任选一个加入, 如果加入多个, proposal返回也会返回多个, 分别对应每个peer的返回内容
        Channel channel = client.newChannel(&quot;mychannel&quot;);
        channel.addOrderer(order);
//        channel.addPeer(peer0);
         channel.addPeer(peer1);
//         channel.addPeer(peer2);
        channel.initialize();

        // 构造链码id对象
        ChaincodeID chaincodeID = BasicTools.createChaincodeID(&quot;demo_zichzhsh&quot;, &quot;1.0&quot;, &quot;github.com/hyperledger/fabric/examples/chaincode/go/demo_zichzhsh&quot;);

        // 构造一个query类型的提议(proposal)
        QueryByChaincodeRequest queryRequest = BasicTools.createQueryProposalRequest(client, chaincodeID, &quot;get&quot;, new String[] { &quot;a&quot; });

        // 发送提议请求
        Collection&lt;ProposalResponse&gt; proposalResponses = BasicTools.doQuery(channel, queryRequest);

        // 接收响应并处理
        for (ProposalResponse proposalResponse : proposalResponses) {
            String result = BasicTools.getProposalResult(proposalResponse);
            if (BasicTools.isProposalResponseSuccess(proposalResponse)) {
                System.out.println(&quot;调用成功&quot;);
            } else {
                System.out.println(&quot;调用失败&quot;);
            }
            System.out.println(result);
        }

    }

    @SuppressWarnings(&quot;unused&quot;)
    private void invokeTest() throws Exception {

        // 构造HyperLedger Client
        HFClient client = BasicTools.createClient();

        // 构造HyperLedger CA Client, 用于用户注册, 用户登记
        HFCAClient caClient = BasicTools.createCaClient(&quot;ca.example.com&quot;, &quot;http://ca.example.com:7054&quot;);

        // 获取用户user1
        SampleUser user1 = BasicTools.getUserPersistent(&quot;user5&quot;, &quot;Org1MSP&quot;);

        // 注册登记user1
        BasicTools.userRegisterAndEnroll(user1, caClient, &quot;Org1MSP&quot;, &quot;org1.department1&quot;, &quot;admin&quot;, &quot;Org1MSP&quot;, &quot;adminpw&quot;);

        // 设置操作用户为user1
        client.setUserContext(user1);

        // 拷贝文件:
        // Y:\demo-fabric\prepare\crypto-config
        // \src\test\fixture\sdkintegration\e2e-2Orgs\channel\crypto-config
        // getOrdererProperties, getPeerProperties内部会去读crypto-config

        // 构造Orderer对象
        Orderer order = BasicTools.getOrderer(client, &quot;orderer.example.com&quot;, &quot;grpc://orderer.example.com:7050&quot;);

        // 构造Peer0对象
        Peer peer0 = BasicTools.getPeer(client, &quot;peer0.org1.example.com&quot;, &quot;grpc://peer0.org1.example.com:7051&quot;);
        // 构造Peer1对象
        Peer peer1 = BasicTools.getPeer(client, &quot;peer1.org1.example.com&quot;, &quot;grpc://peer1.org1.example.com:8051&quot;);
        // 构造Peer2对象
        Peer peer2 = BasicTools.getPeer(client, &quot;peer2.org1.example.com&quot;, &quot;grpc://peer2.org1.example.com:9051&quot;);

        // 构造channel, 添加orderer和peer到channel, 初始化channel
        // peer任选一个加入, 如果加入多个, proposal返回也会返回多个, 分别对应每个peer的返回内容
        Channel channel = client.newChannel(&quot;mychannel&quot;);
        channel.addOrderer(order);
//        channel.addPeer(peer0);
//         channel.addPeer(peer1);
         channel.addPeer(peer2);
        channel.initialize();

        // 构造链码id对象
        ChaincodeID chaincodeID = BasicTools.createChaincodeID(&quot;demo_zichzhsh&quot;, &quot;1.0&quot;, &quot;github.com/hyperledger/fabric/examples/chaincode/go/demo_zichzhsh&quot;);

        // 构造一个transaction类型的提议(proposal)
        TransactionProposalRequest transactionProposalRequest = BasicTools.createTransactionProposalRequest(client, chaincodeID, &quot;put&quot;, new String[] { &quot;a&quot;, &quot;this is a&quot;, &quot;i am a&quot; });

        // 发送提议
        Collection&lt;ProposalResponse&gt; proposalResponses = BasicTools.doTransaction(channel, transactionProposalRequest);

        // 接收响应并处理
        for (ProposalResponse proposalResponse : proposalResponses) {
            String result = BasicTools.getProposalResult(proposalResponse);
            if (BasicTools.isProposalResponseSuccess(proposalResponse)) {
                System.out.println(&quot;调用成功&quot;);
            } else {
                System.out.println(&quot;调用失败&quot;);
            }
            System.out.println(result);
        }


    }


    public static void main(String[] args) throws Exception {
        new End2End().queryTest();
        new End2End().invokeTest();
    }
}
</code></pre>


</div>
<script src="../js/jquery-1.12.3.min.js" charset="utf-8"></script>
<link rel="stylesheet" href="../css/highlight.min.css">
<script src="../js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">
jQuery(function ($) {
});
</script></body></html>

